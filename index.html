<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>YOLO Eye Capture</title>
<style>
  :root{--bg:#0f172a;--muted:#94a3b8;--accent:#22c55e}
  *{box-sizing:border-box} body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  header{padding:18px 16px;text-align:center;border-bottom:1px solid #1f2937;background:#0b1220aa;backdrop-filter:blur(6px);position:sticky;top:0;z-index:30}
  main{max-width:980px;margin:10px auto 32px;padding:0 16px}
  .card{background:#111827e6;border:1px solid #1f2937;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.4)}
  .section{padding:16px;border-top:1px dashed #1f2937}.section:first-child{border-top:none}
  .grid{display:grid;gap:16px}@media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input[type="text"]{width:260px;padding:10px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  input[type="checkbox"]{transform:scale(1.2)}
  button{padding:12px 16px;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:#e5e7eb;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#16a34a,#16a34a 60%,#15803d);border-color:#14532d}
  button.secondary{background:#0b1220}
  button:disabled{opacity:.5;cursor:not-allowed}
  .video-wrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid #1f2937}
  video,canvas{display:block;width:100%;height:auto} canvas.overlay{position:absolute;inset:0;pointer-events:none}
  .muted{color:#94a3b8}.ok{color:#22c55e}.err{color:#ef4444}.kbd{font-family:ui-monospace,monospace;background:#111827;border:1px solid #1f2937;border-bottom-width:3px;padding:2px 6px;border-radius:6px;color:#cbd5e1}
  .thumbs-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}.thumbs-grid img{width:100%;border-radius:10px;border:1px solid #1f2937}
  .toolbar{position:sticky;top:64px;z-index:20;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;padding:6px 10px;margin:8px 0 0;background:#0b1220e0;border:1px solid #1f2937;border-radius:12px;backdrop-filter:blur(6px)}
  .toolbar .left,.toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.toolbar .center{display:flex;align-items:center;justify-content:center}
  .btn-capture{padding:12px 24px;border-radius:999px;font-size:1.05rem}
  .unmirror{transform:scaleX(-1);transform-origin:center}
  #consent{position:fixed;inset:0;background:#000000d9;display:flex;align-items:center;justify-content:center;z-index:40}
  #consent .box{max-width:680px;background:#0f172a;border:1px solid #1f2937;border-radius:14px;padding:18px}
  .flashfx{position:absolute;inset:0;pointer-events:none}
  .flashfx .quad{position:absolute;width:50%;height:50%;background:#fff;opacity:0}
  .quad.tl{left:0;top:0}.quad.tr{right:0;top:0}.quad.br{right:0;bottom:0}.quad.bl{left:0;bottom:0}
</style>
<script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
<header><strong>YOLO Eye Capture</strong></header>

<!-- Consent -->
<div id="consent">
  <div class="box">
    <h2>Consent & Identification</h2>
    <p class="muted">By pressing “I agree”, you authorize the use of your eye image exclusively for scientific/research purposes.</p>
    <div class="row" style="margin-top:8px">
      <input id="name" type="text" placeholder="Participant name" />
      <label class="row" style="gap:8px"><input id="consentChk" type="checkbox"> I agree</label>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="consentOk" class="primary">Continue</button>
    </div>
  </div>
</div>

<main>
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="left">
      <button id="start" class="primary" disabled>Start</button>
      <button id="flip" class="secondary" disabled>Switch</button>
      <button id="flashBtn" class="secondary" disabled title="Rear: torch stays on/off. Front: quad sequence when On.">Flash: On</button>
    </div>
    <div class="center">
      <button id="capture" class="primary btn-capture" disabled>Capture</button>
    </div>
    <div class="right muted">
      <span id="modelStatus">Model: not loaded</span>
      <span>&nbsp;•&nbsp;</span><span id="fps">— fps</span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="section grid">
      <div>
        <h2>Instructions</h2>
        <ol class="muted" style="line-height:1.7">
          <li>Position yourself in front of the camera.</li>
          <li>Focus your eye on the camera.</li>
          <li>Keep a distance of ~10–15 cm.</li>
          <li>Open your eye wide and hold still.</li>
          <li>When you hear the beep, press “Capture”.</li>
        </ol>
      </div>
      <div class="muted">
        <div>Camera: <span id="camLabel" class="kbd">—</span></div>
        <div style="margin-top:6px">Status: <span id="consentStatus" class="err">Consent/name missing</span></div>
      </div>
    </div>

    <div class="section">
      <div class="video-wrap">
        <video id="video" playsinline muted></video>
        <canvas id="overlay" class="overlay"></canvas>
        <div id="flashFx" class="flashfx" aria-hidden="true">
          <div class="quad tl"></div><div class="quad tr"></div><div class="quad br"></div><div class="quad bl"></div>
        </div>
      </div>
    </div>

    <div class="section grid">
      <div>
        <h3>Result</h3>
        <div class="thumbs-grid">
          <img id="thumb1" alt="Eye crop 1"/>
          <img id="thumb2" alt="Eye crop 2"/>
          <img id="thumb3" alt="Eye crop 3"/>
          <img id="thumb4" alt="Eye crop 4"/>
        </div>
      </div>
      <div>
        <h3>Upload</h3>
        <p class="muted">The cropped eye image(s) will be uploaded to Google Drive.</p>
        <div id="uploadLog" class="muted" style="font-family:ui-monospace,monospace">Ready.</div>
      </div>
    </div>
  </div>
</main>

<script>
/* ===== CONFIG ===== */
const MODEL_URL = "https://huggingface.co/pedro123gtz/yolo-eye-model/resolve/main/best.onnx";
const MODEL_INPUT_SIZE = 320;
const MODEL_CONF_THRESHOLD = 0.35;
const MODEL_IOU_THRESHOLD = 0.45;

const DRIVE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzkYb6I_QFDCbqaXlVInrj-k31WfisUj8hbumzIi7xQORE4WcyoMe42KNiDAXpBI9JJ/exec";
const UNMIRROR_FRONT = true;
const QUAD_ON = 1500, QUAD_OFF = 150, QUAD_CAPTURE_AT = Math.floor(QUAD_ON/2);


/* ===== DOM/STATE ===== */
const $ = s=>document.querySelector(s);
const consent=$("#consent"), nameInput=$("#name"), chk=$("#consentChk"), okBtn=$("#consentOk");
const consentStatus=$("#consentStatus");
const startBtn=$("#start"), flipBtn=$("#flip"), captureBtn=$("#capture"), flashBtn=$("#flashBtn");
const modelStatus=$("#modelStatus"), fpsLabel=$("#fps"), camLabel=$("#camLabel");
const video=$("#video"), overlay=$("#overlay"), ctx=overlay.getContext("2d");
const flashFx=$("#flashFx"), quads=[...flashFx.querySelectorAll('.quad')];
const thumbs=[$("#thumb1"),$("#thumb2"),$("#thumb3"),$("#thumb4")]; const uploadLog=$("#uploadLog");

let streaming=false, currentStream=null, videoTrack=null, useFront=true;
let audioCtx=null, track=null, tick=0, RUN_EVERY=3, lockedBeeped=false;
let flashEnabled=true; // global UI state

/* ===== consent ===== */
function updateConsent(){
  const ok = !!nameInput.value.trim() && chk.checked;
  consentStatus.textContent = ok? "Ready" : "Consent/name missing";
  consentStatus.className = ok? "ok":"err";
  startBtn.disabled = !ok;
}
nameInput.addEventListener('input',updateConsent); chk.addEventListener('change',updateConsent);
okBtn.addEventListener('click',()=>{updateConsent(); if(!startBtn.disabled) { consent.style.display="none"; flashBtn.disabled=false; }});

/* ===== beeps ===== */
function beep(freq=880, dur=120, type='sine', gain=0.06){
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.type=type; osc.frequency.value=freq; g.gain.value=gain; osc.connect(g).connect(audioCtx.destination);
    osc.start(); setTimeout(()=>osc.stop(),dur);
  }catch(e){}
}

/* ===== torch helpers ===== */
async function setTorch(on){
  try{
    if(!videoTrack || typeof videoTrack.getCapabilities!=='function') return false;
    const caps = videoTrack.getCapabilities();
    if(!('torch' in caps)) return false;
    await videoTrack.applyConstraints({ advanced: [{ torch: !!on }] });
    return true;
  }catch(e){ return false; }
}

/* Apply UI flash state to current camera:
   - Rear: torch = flashEnabled
   - Front: torch = false (not supported); flashEnabled governs quad sequence only
*/
async function applyFlashState(){
  if(!streaming) return;
  if(useFront){
    // ensure torch is off on front camera
    await setTorch(false);
  }else{
    // rear camera: keep torch synced with flashEnabled
    await setTorch(!!flashEnabled);
  }
}
function updateFlashBtn(){ flashBtn.textContent = flashEnabled ? 'Flash: On' : 'Flash: Off'; }
flashBtn.addEventListener('click', async ()=>{
  flashEnabled = !flashEnabled;
  updateFlashBtn();
  await applyFlashState();
});

/* ===== YOLO mini API ===== */
window.eyeapi=(function(){
  const api={};
  api.nets={eyeDetector:{session:null,async loadFromUrl(url,providers=['webgpu','wasm']){
    for(const ep of providers){try{this.session=await ort.InferenceSession.create(url,{executionProviders:[ep]});return{provider:ep};}catch(e){}}
    throw new Error('Model load failed');}}};
  class Opts{constructor({inputSize=MODEL_INPUT_SIZE,confThreshold=MODEL_CONF_THRESHOLD,iouThreshold=MODEL_IOU_THRESHOLD}={}){Object.assign(this,{inputSize,confThreshold,iouThreshold});}}
  api.EyeDetectorOptions=Opts;
  function letterbox(img,S){const iw=img.videoWidth||img.width,ih=img.videoHeight||img.height,r=Math.min(S/iw,S/ih),nw=Math.round(iw*r),nh=Math.round(ih*r),dx=Math.floor((S-nw)/2),dy=Math.floor((S-nh)/2);const c=document.createElement('canvas');c.width=S;c.height=S;const t=c.getContext('2d');t.fillStyle='#000';t.fillRect(0,0,S,S);t.drawImage(img,0,0,iw,ih,dx,dy,nw,nh);return{canvas:c,ratio:r,dx,dy,iw,ih};}
  function post(out,m,ct,iouT){let d=out.data,nb,na;if(out.dims.length===3){const[n,a,b]=out.dims;nb=b;na=a;const tr=new Float32Array(nb*na);for(let i=0;i<a;i++)for(let j=0;j<b++)tr[j*na+i]=d[i*b+j];d=tr;}else{nb=out.dims[0];na=out.dims[1];}
    const s=x=>1/(1+Math.exp(-x)), boxes=[],scores=[];for(let i=0;i<nb;i++){const o=i*na,x=d[o],y=d[o+1],w=d[o+2],h=d[o+3],obj=s(d[o+4]);let cs=1;if(na>5){let best=0;for(let c=5;c<na;c++){const sc=s(d[o+c]);if(sc>best){best=sc;}}cs=best;}const conf=obj*cs;if(conf<ct)continue;boxes.push([x-w/2,y-h/2,x+w/2,y+h/2]);scores.push(conf);}
    const keep=(function(B,S,iou,maxDet=50){const ord=S.map((v,i)=>[v,i]).sort((A,B)=>B[0]-A[0]).map(x=>x[1]);const out=[];function IOU(a,b){const x1=Math.max(a[0],b[0]),y1=Math.max(a[1],b[1]),x2=Math.min(a[2],b[2]),y2=Math.min(a[3],b[3]);const w=Math.max(0,x2-x1),h=Math.max(0,y2-y1),inter=w*h,A=(a[2]-a[0])*(a[3]-a[1]),B=(b[2]-b[0])*(b[3]-b[1]);return inter/(A+B-inter+1e-6);}for(const i of ord){let ok=true;for(const j of out){if(IOU(B[i],B[j])>iou){ok=false;break;}}if(ok){out.push(i);if(out.length>=maxDet)break;}}return out;})(boxes,scores,iouT);
    const res=[];for(const i of keep){const [x1,y1,x2,y2]=boxes[i],{ratio,dx,dy,iw,ih}=m,sx1=(x1-dx)/ratio,sy1=(y1-dy)/ratio,sx2=(x2-dx)/ratio,sy2=(y2-dy)/ratio;const X1=Math.max(0,Math.min(iw,sx1)),Y1=Math.max(0,Math.min(ih,sy1)),X2=Math.max(0,Math.min(iw,sx2)),Y2=Math.max(0,Math.min(ih,sy2));res.push({box:[X1,Y1,X2,Y2],score:scores[i]});}return res;}
  api.detectAllEyes=async function(input,opt=new Opts()){const sess=api.nets.eyeDetector.session;const lb=letterbox(input,opt.inputSize),px=lb.canvas.getContext('2d').getImageData(0,0,lb.canvas.width,lb.canvas.height).data,size=opt.inputSize*opt.inputSize,arr=new Float32Array(size*3);for(let i=0,p=0;i<size;i++,p+=4){arr[i]=px[p]/255;arr[i+size]=px[p+1]/255;arr[i+2*size]=px[p+2]/255;}
    const t0=performance.now();const out=await sess.run({[sess.inputNames[0]]:new ort.Tensor('float32',arr,[1,3,opt.inputSize,opt.inputSize])});fpsLabel.textContent=`${(1000/(performance.now()-t0)).toFixed(1)} fps`;
    return post(out[sess.outputNames[0]],lb,opt.confThreshold,MODEL_IOU_THRESHOLD);
  };
  return api;
})();

/* ===== helpers ===== */
const area=b=>Math.max(0,b[2]-b[0])*Math.max(0,b[3]-b[1]);
const IOU=(a,b)=>{const x1=Math.max(a[0],b[0]),y1=Math.max(a[1],b[1]),x2=Math.min(a[2],b[2]),y2=Math.min(a[3],b[3]);const w=Math.max(0,x2-x1),h=Math.max(0,y2-y1),inter=w*h,A=(a[2]-a[0])*(a[3]-a[1]),B=(b[2]-b[0])*(b[3]-b[1]);return inter/(A+B-inter+1e-6);}
const EMA=(p,c,a)=>[p[0]*(1-a)+c[0]*a,p[1]*(1-a)+c[1]*a,p[2]*(1-a)+c[2]*a,p[3]*(1-a)+c[3]*a];
const STAB={confMin:0.55,minAreaRatio:0.005,ema:0.35,iouKeep:0.50,maxCoast:6,need:8};
function bestDet(dets){const W=overlay.width,H=overlay.height,minA=STAB.minAreaRatio*W*H;const f=dets.filter(d=>d.score>=STAB.confMin && area(d.box)>=minA);if(!f.length)return null;f.sort((a,b)=>b.score-a.score);return f[0];}
function drawTrack(t){ctx.clearRect(0,0,overlay.width,overlay.height);if(!t)return;const [x1,y1,x2,y2]=t.box,w=x2-x1,h=y2-y1;ctx.lineWidth=3;ctx.strokeStyle='#22c55e';ctx.fillStyle='rgba(34,197,94,.12)';ctx.beginPath();ctx.rect(x1,y1,w,h);ctx.stroke();ctx.fill();const tag=`eye ${(t.score*100).toFixed(0)}% · ${t.stable}f`;ctx.font='16px ui-monospace,monospace';const tw=ctx.measureText(tag).width+10;ctx.fillStyle='#0b1220';ctx.fillRect(x1,Math.max(0,y1-22),tw,22);ctx.fillStyle='#93c5fd';ctx.fillText(tag,x1+5,Math.max(16,y1-6));}
function enableUI(){flipBtn.disabled=false;flashBtn.disabled=false;}

/* ===== camera ===== */
async function startCam(){
  if(currentStream){
    try{ await setTorch(false); }catch(_){}
    currentStream.getTracks().forEach(t=>t.stop());
  }
  const facing=useFront?'user':'environment';
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode=facing,width:{ideal:1280},height:{ideal:720}},audio:false});
    currentStream=stream; video.srcObject=stream; await video.play();
    overlay.width=video.videoWidth; overlay.height=video.videoHeight; camLabel.textContent=facing; streaming=true; enableUI();
    const need=UNMIRROR_FRONT && useFront; video.classList.toggle('unmirror',need); overlay.classList.toggle('unmirror',need);
    videoTrack=stream.getVideoTracks()[0];
    // aplicar estado de flash al entrar en la cámara
    await applyFlashState();
  }catch(e){alert('Camera error: '+e.message);}
}
flipBtn.addEventListener('click',async()=>{
  // al cambiar de cámara, apaga torch previo y vuelve a aplicar estado
  try{ await setTorch(false); }catch(_){}
  useFront=!useFront; lockedBeeped=false;
  await startCam();
});
startBtn.addEventListener('click',async()=>{await startCam(); await loadModel(); detectLoop();});

async function loadModel(){
  modelStatus.textContent='Model: loading…';
  try{
    const {provider}=await eyeapi.nets.eyeDetector.loadFromUrl(MODEL_URL,['webgpu','wasm']);
    const tmp=document.createElement('canvas'); tmp.width=MODEL_INPUT_SIZE; tmp.height=MODEL_INPUT_SIZE;
    await eyeapi.detectAllEyes(tmp,new eyeapi.EyeDetectorOptions({inputSize:MODEL_INPUT_SIZE,confThreshold:0.99}));
    modelStatus.textContent=`Model: ready (${provider})`;
  }catch(e){console.error(e);modelStatus.textContent='Model: load error';}
}

/* ===== detect loop ===== */
async function detectLoop(){
  const opts=new eyeapi.EyeDetectorOptions();
  while(streaming){
    try{
      tick++; if(tick%RUN_EVERY){drawTrack(track); updateCaptureBtn(); await new Promise(r=>setTimeout(r,10)); continue;}
      const dets=await eyeapi.detectAllEyes(video,opts); const best=bestDet(dets);
      if(!track && best){track={box:[...best.box],score:best.score,stable:1,coast:0};}
      else if(track){ if(best){ if(IOU(track.box,best.box)>=STAB.iouKeep){track.box=EMA(track.box,best.box,STAB.ema);track.score=best.score;track.stable++;track.coast=0;} else track.coast++; } else track.coast++; if(track.coast>STAB.maxCoast){track=null;lockedBeeped=false;} }
      drawTrack(track); updateCaptureBtn();
      if(track && track.stable>=STAB.need && !lockedBeeped){ beep(1175,140,'square',0.08); setTimeout(()=>beep(880,120,'sine',0.05),160); lockedBeeped=true; }
      if(!track) lockedBeeped=false;
    }catch(e){console.error(e); await new Promise(r=>setTimeout(r,100));}
    await new Promise(r=>setTimeout(r,10));
  }
}
function updateCaptureBtn(){ captureBtn.disabled = !(track && track.stable>=STAB.need); }

/* ===== capture helpers ===== */
function cropToBlob(det){const [x1,y1,x2,y2]=det.xyxy?det.xyxy:det.box;const X1=Math.round(x1),Y1=Math.round(y1),W=Math.max(1,Math.round(x2-x1)),H=Math.max(1,Math.round(y2-y1));const c=document.createElement('canvas');c.width=W;c.height=H;c.getContext('2d').drawImage(video,X1,Y1,W,H,0,0,W,H);return new Promise(res=>c.toBlob(b=>res(b),'image/jpeg',0.95));}

async function flashQuad(i){const q=quads[i];q.style.opacity='1';await new Promise(r=>setTimeout(r,QUAD_CAPTURE_AT));beep(1319,100,'square',0.12);const b=await cropToBlob({xyxy:track.box});await new Promise(r=>setTimeout(r,QUAD_ON-QUAD_CAPTURE_AT));q.style.opacity='0';await new Promise(r=>setTimeout(r,QUAD_OFF));return b;}

async function captureFront(){
  if(flashEnabled){
    const order=[0,1,2,3]; const blobs=[];
    for(let i=0;i<order.length;i++){blobs.push(await flashQuad(order[i])); thumbs[i].src=URL.createObjectURL(blobs[i]);}
    for(const b of blobs){await uploadToDrive(b);}
  }else{
    beep(1319,100,'square',0.12);
    const b=await cropToBlob({xyxy:track.box});
    thumbs[0].src=URL.createObjectURL(b); for(let i=1;i<4;i++) thumbs[i].src='';
    await uploadToDrive(b);
  }
}

async function captureRear(){
  // Torch ya está controlado por applyFlashState() según botón
  beep(1319,100,'square',0.12);
  const b=await cropToBlob({xyxy:track.box});
  thumbs[0].src=URL.createObjectURL(b); for(let i=1;i<4;i++) thumbs[i].src='';
  await uploadToDrive(b);
}

async function capture(){ if(!track || track.stable<STAB.need) return; if(useFront) await captureFront(); else await captureRear(); }
captureBtn.addEventListener('click',capture);
document.addEventListener('keydown',e=>{ if(captureBtn.disabled) return; if(e.code==='Space'||e.key===' '||e.key==='Enter'||e.code==='NumpadEnter'){e.preventDefault(); capture();} });

/* ===== upload using URLSearchParams ===== */
function blobToBase64(blob){return new Promise((resolve,reject)=>{const fr=new FileReader();fr.onload=()=>resolve(String(fr.result).replace(/^data:.*;base64,/,""));fr.onerror=reject;fr.readAsDataURL(blob);});}
async function uploadToDrive(blob){
  const user=(nameInput.value||"anonymous").trim()||"anonymous";
  try{
    const base64=await blobToBase64(blob);
    const params=new URLSearchParams({ image:base64, name:user });
    const resp=await fetch(DRIVE_WEBAPP_URL,{
      method:'POST', mode:'cors', credentials:'omit',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:params
    });
    const text=await resp.text(); if(!resp.ok) throw new Error(`HTTP ${resp.status} · ${text||'upload failed'}`);
    uploadLog.textContent = text || 'Uploaded.';
  }catch(err){
    try{
      const base64=await blobToBase64(blob);
      const params2=new URLSearchParams({ image:base64, name:(nameInput.value||'anonymous').trim()||'anonymous' });
      await fetch(DRIVE_WEBAPP_URL,{ method:'POST', mode:'no-cors', body:params2 });
      uploadLog.textContent='Sent (no-cors). Please check the Drive folder.';
    }catch(e2){
      console.error('Upload failed:', e2);
      uploadLog.textContent='Upload error: '+(e2?.message||e2);
    }
  }
}

/* ===== init ===== */
(function init(){ updateConsent(); updateFlashBtn(); })();
</script>
</body>
</html>

